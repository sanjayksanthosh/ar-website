<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebAR Object Viewer</title>
    
    <!-- Tailwind CSS for modern UI overlay -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- A-Frame and AR.js libraries for 3D and Augmented Reality -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        /* Ensures the camera canvas stays in the background */
        .a-canvas {
            z-index: 0 !important;
        }
        #overlay {
            z-index: 10;
        }
        
        /* FIX: Prevent Tailwind from messing with AR.js video element */
        video {
            object-fit: initial !important; /* Prevent 'cover' or 'contain' processing */
        }
        #arjs-video, body > video {
            max-width: none !important;
            height: auto !important;
            width: auto !important;
            min-width: 100% !important;
            min-height: 100% !important;
            display: block !important;
            position: absolute !important;
            top: 0;
            left: 0;
            z-index: -1 !important; /* Ensure it stays behind the canvas */
        }
    </style>

    <!-- Camera Switcher / Override Script (Must run before AR.js init sometimes) -->
    <script>
        // Check for deviceId in URL and override getUserMedia to force specific camera
        const urlParams = new URLSearchParams(window.location.search);
        const currentDeviceId = urlParams.get('deviceId');

        if (currentDeviceId) {
            console.log("Overriding getUserMedia for deviceId:", currentDeviceId);
            const origGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
            navigator.mediaDevices.getUserMedia = function(constraints) {
                if (constraints && constraints.video) {
                    // Create a new constraint object to avoid mutating the original reference in unexpected ways
                    let newConstraints = JSON.parse(JSON.stringify(constraints));
                    if (typeof newConstraints.video === 'boolean') {
                        newConstraints.video = { deviceId: { exact: currentDeviceId } };
                    } else {
                        newConstraints.video.deviceId = { exact: currentDeviceId };
                        delete newConstraints.video.facingMode; // Remove facing mode if ID is present
                    }
                    console.log("Requested constraints:", newConstraints);
                    return origGetUserMedia(newConstraints);
                }
                return origGetUserMedia(constraints);
            };
        }

        window.addEventListener('load', () => {
             // Create Switch Button UI
            const switchBtn = document.createElement('button');
            switchBtn.innerText = "Switch Camera";
            if (!document.getElementById('switch-camera-btn')) {
                switchBtn.id = 'switch-camera-btn';
                switchBtn.className = "fixed bottom-4 right-4 z-50 bg-white text-gray-900 px-4 py-2 rounded-full font-bold shadow-lg active:scale-95 transition-transform text-sm";
                switchBtn.onclick = switchCamera;
                document.body.appendChild(switchBtn);
            }

            // Create Debug Info Panel
            const debugPanel = document.createElement('div');
            debugPanel.id = 'camera-debug-info';
            debugPanel.className = "fixed top-0 left-0 p-2 bg-black/70 text-green-400 text-xs font-mono z-50 pointer-events-none max-w-full break-words";
            debugPanel.style.maxWidth = '300px';
            debugPanel.innerText = "Waiting for stream...";
            document.body.appendChild(debugPanel);

            // Function to update debug info
            function updateDebugInfo(stream) {
                if (!stream) return;
                const track = stream.getVideoTracks()[0];
                if (!track) return;

                const settings = track.getSettings();
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                const label = track.label;

                debugPanel.innerHTML = `
                    <strong>Camera:</strong> ${label}<br>
                    <strong>ID:</strong> ${settings.deviceId}<br>
                    <strong>Res:</strong> ${settings.width}x${settings.height}<br>
                    <strong>Aspect:</strong> ${settings.aspectRatio}<br>
                    <strong>FrameRate:</strong> ${settings.frameRate}<br>
                    <strong>Focus:</strong> ${settings.focusMode}<br>
                    <strong>Zoom:</strong> ${settings.zoom}<br>
                `;
            }

            // Hook into getUserMedia to steal the stream for debug info
            const oldGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
            navigator.mediaDevices.getUserMedia = async function(constraints) {
                try {
                    const stream = await oldGetUserMedia(constraints);
                    updateDebugInfo(stream);
                    return stream;
                } catch (err) {
                    debugPanel.innerText = "Error: " + err.message;
                    throw err;
                }
            };

            async function switchCamera() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length < 2) {
                        alert("Only one camera found.");
                        return;
                    }

                    let currentIndex = 0;
                    if (currentDeviceId) {
                        currentIndex = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
                        if (currentIndex === -1) currentIndex = 0; // fallback
                    }
                    
                    const nextIndex = (currentIndex + 1) % videoDevices.length;
                    const nextDeviceId = videoDevices[nextIndex].deviceId;

                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('deviceId', nextDeviceId);
                    window.location.href = newUrl.toString();

                } catch (err) {
                    console.error("Error switching camera:", err);
                    alert("Switch error: " + err.message);
                }
            }
        });
    </script>
</head>
<body class="m-0 overflow-hidden bg-gray-900">

    <!-- User Interface Overlay -->
    <!-- Mobile-Friendly Scanner Overlay -->
    <div id="overlay" class="absolute inset-0 pointer-events-none flex flex-col items-center justify-center z-10">
        
        <!-- Scanner Frame -->
        <div id="scanner-frame" class="relative w-64 h-64 border-2 border-white/50 rounded-lg flex items-center justify-center transition-opacity duration-300">
            <!-- Corner Accents for "Scanner" look -->
            <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white -mt-1 -ml-1 rounded-tl-lg"></div>
            <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white -mt-1 -mr-1 rounded-tr-lg"></div>
            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white -mb-1 -ml-1 rounded-bl-lg"></div>
            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white -mb-1 -mr-1 rounded-br-lg"></div>
            
            <!-- Pulsing Center Dot (Optional guidance) -->
            <div class="w-2 h-2 bg-white/80 rounded-full animate-ping"></div>
        </div>

        <!-- Instructions -->
        <div id="instructions" class="mt-8 bg-black/40 backdrop-blur-sm px-6 py-3 rounded-full text-center transition-opacity duration-300">
            <p class="text-white font-medium text-lg drop-shadow-md">Scan Hiro Marker</p>
            <p class="text-white/70 text-xs mt-1">Point camera at the marker to view object</p>
        </div>

        <!-- Error / Status Message (Hidden by default) -->
        <div id="error-message" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center p-8 text-center pointer-events-auto z-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-white text-xl font-bold mb-2">Camera Error</h3>
            <p id="error-text" class="text-gray-300 text-sm mb-6">Unable to access camera.</p>
            <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition-colors">
                Retry
            </button>
            <p class="text-gray-500 text-xs mt-4">
                Note: Mobile browsers require HTTPS for camera access. If testing on LAN, use localhost forwarding or a secure tunnel.
            </p>
        </div>

        <!-- Marker DL Link (Small, active) -->
        <a href="https://upload.wikimedia.org/wikipedia/commons/4/48/Hiro_marker_ARjs.png" target="_blank" class="pointer-events-auto absolute bottom-8 text-white/60 text-xs underline hover:text-white transition-colors">
            Get Marker
        </a>
    </div>

    <script>
        // Camera Error Handling
        window.addEventListener('load', () => {
            const scene = document.querySelector('a-scene');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const scannerFrame = document.getElementById('scanner-frame');
            const instructions = document.getElementById('instructions');

            // Listen for camera initialization errors
            scene.addEventListener('camera-error', (e) => {
                console.error('Camera Error:', e.detail);
                showError('Camera access denied or device not supported.');
            });

            // Check if camera stream is active after a timeout
            setTimeout(() => {
                const video = document.querySelector('video');
                if (!video || video.paused || video.ended) {
                    // Try to catch silent failures, but be careful not to trigger if just loading slowly
                    console.log('Video check: Stream might be inactive.');
                }
            }, 5000);

            function showError(msg) {
                scannerFrame.classList.add('opacity-0');
                instructions.classList.add('opacity-0');
                errorMessage.classList.remove('hidden');
                errorText.textContent = msg + " Ensure you are using HTTPS.";
            }
        });
    </script>

    <!-- AR.js Scene -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true"
    >
        <!-- The Anchor Marker: We use the standard 'Hiro' preset -->
        <a-marker preset="hiro">
            
            <!-- The 3D Object Group (Floating and Rotating) -->
            <a-entity
                position="0 1 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 6000; easing: linear"
            >
                <!-- Outer complex shape (Torus Knot) -->
                <a-torus-knot 
                    scale="0.25 0.25 0.25" 
                    color="#6366f1" 
                    arc="180" 
                    p="2" 
                    q="3" 
                    radius="1" 
                    radius-tubular="0.1">
                </a-torus-knot>
                
                <!-- Inner glowing sphere -->
                <a-sphere 
                    scale="0.2 0.2 0.2" 
                    color="#ec4899" 
                    material="opacity: 0.9; transparent: true; metalness: 0.5; roughness: 0.2">
                </a-sphere>
            </a-entity>

            <!-- Base/Pedestal to visually anchor the floating object to the real-world marker -->
            <a-cylinder 
                position="0 0.05 0" 
                radius="0.7" 
                height="0.05" 
                color="#1f2937" 
                material="opacity: 0.8; transparent: true">
            </a-cylinder>
            
            <!-- Outer decorative ring on the pedestal -->
            <a-torus 
                position="0 0.05 0" 
                radius="0.7" 
                radius-tubular="0.01" 
                color="#ec4899" 
                rotation="90 0 0">
            </a-torus>

        </a-marker>

        <!-- The AR Camera -->
        <a-entity camera></a-entity>
    </a-scene>



</body>
</html>